"use strict";function ownKeys(r,e){var t,n=Object.keys(r);return Object.getOwnPropertySymbols&&(t=Object.getOwnPropertySymbols(r),e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),n.push.apply(n,t)),n}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _createForOfIteratorHelper(e,r){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,i=!1;return{s:function(){t=e[Symbol.iterator]()},n:function(){var e=t.next();return s=e.done,e},e:function(e){i=!0,o=e},f:function(){try{s||null==t.return||t.return()}finally{if(i)throw o}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function asyncGeneratorStep(e,r,t,n,a,o,s){try{var i=e[o](s),c=i.value}catch(e){return void t(e)}i.done?r(c):Promise.resolve(c).then(n,a)}function _asyncToGenerator(i){return function(){var e=this,s=arguments;return new Promise(function(r,t){var n=i.apply(e,s);function a(e){asyncGeneratorStep(n,r,t,a,o,"next",e)}function o(e){asyncGeneratorStep(n,r,t,a,o,"throw",e)}a(void 0)})}}var Message=require("./../dbmodel/Message"),User=require("./../dbmodel/User"),_require=require("../common/util"),getJWTPayload=_require.getJWTPayload,timeago=_require.timeago,reMapError=_require.reMapError,sendEmail=_require.sendEmail,_require2=require("../common/apiPrefix"),queryUser=_require2.queryUser,setAllAvatar=_require2.setAllAvatar,routerExports={};function escapeMessage(e){return e?e.replace(/<\/?script>/g,""):""}function setAvatar(e){return new Promise(function(r){User.findOne({name:e}).then(function(e){r(e&&e.avatar||"")})})}function callGetMessageByPageSize(){return new Promise(function(u,d){Message.find({},function(e,r){e?d([]):u(r);var t,n=_createForOfIteratorHelper(r.sort(function(e,r){return new Date(e.date.replace(/-----/g," ").replace(/ : /g,":")).getTime()-new Date(r.date.replace(/-----/g," ").replace(/ : /g,":")).getTime()}));try{for(n.s();!(t=n.n()).done;){var a=t.value;if(a.repeat&&0!==a.repeat.length){var o,s=_createForOfIteratorHelper(a.repeat);try{for(s.s();!(o=s.n()).done;){var i,c=o.value;c&&null!==c&&(i=new Date(c.date).getTime(),c.date=timeago(i))}}catch(e){s.e(e)}finally{s.f()}}}}catch(e){n.e(e)}finally{n.f()}})})}routerExports.deleteInnerRepeat={method:"post",url:"/deleteInnerRepeat",route:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o,s,i,c,u,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.body,a=n._id,o=n._parent_id,s=n.toRepeatUserId,e.prev=1,i=getJWTPayload(r.headers.authorization)){e.next=5;break}throw"token认证失败";case 5:return e.next=7,User.findOne({_id:i._id});case 7:if(c=e.sent){e.next=10;break}throw"当前用户不存在或会话已过期";case 10:if(s===i._id||c.admin){e.next=12;break}throw"只能删除自己的回复";case 12:return e.next=14,Message.findOne({_id:o});case 14:if(u=e.sent){e.next=17;break}throw"该条回复不存在";case 17:return d=u.repeat.filter(function(e){return e._id!=a}),e.next=20,Message.updateOne({_id:o},{$set:{repeat:_toConsumableArray(d)}});case 20:r.body={success:!0,data:d},e.next=26;break;case 23:e.prev=23,e.t0=e.catch(1),r.body={success:!1,errorMsg:e.t0};case 26:case"end":return e.stop()}},e,null,[[1,23]])}));return function(e,r){return t.apply(this,arguments)}}()},routerExports.getMessageByPageSize={method:"post",url:"/getMessageByPageSize",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,o,s,i,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.request.body,n=t.pageSize,a=t.index,e.prev=1,o=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=_createForOfIteratorHelper(r),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=11;break}return a=n.value,e.next=7,setAvatar(a.name);case 7:o=e.sent,a.avatar=o;case 9:e.next=3;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(1),t.e(e.t0);case 16:return e.prev=16,t.f(),e.finish(16);case 19:return e.abrupt("return",r);case 20:case"end":return e.stop()}},e,null,[[1,13,16,19]])}));return function(e){return r.apply(this,arguments)}}(),e.next=5,callGetMessageByPageSize(n);case 5:return s=e.sent,i=_toConsumableArray(s).reverse(),c={data:i.slice(a,n)},e.next=10,o(c.data);case 10:u=e.sent,r.body={success:!0,data:u,total:s.length,isOver:s.length<=n},e.next=17;break;case 14:e.prev=14,e.t0=e.catch(1),r.body={success:!1,errorMsg:e.t0};case 17:case"end":return e.stop()}},e,null,[[1,14]])}));return function(e){return r.apply(this,arguments)}}()},routerExports._repeatMsg={method:"post",url:"/repeatmsg",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,o,s,i,c,u,d,l,p,f,y,m,b;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.request.body,n=t._id,a=t.toRepeat,o=t.info,s=t.toRepeatId,e.prev=1,i=getJWTPayload(r.headers.authorization)){e.next=5;break}throw"token认证失败";case 5:return e.next=7,User.findOne({_id:i._id});case 7:if(c=e.sent){e.next=10;break}throw"当前用户不存在";case 10:if(i._id===s)throw"请勿回复自己";e.next=12;break;case 12:return e.next=14,queryUser({userId:s,name:a});case 14:return u=e.sent,d=c.name,l=c.avatar,p=c.eamil,f={userId:i._id,toRepeat:a,date:Date.now(),info:o,name:d,avatar:l,eamil:p,toRepeatUser:u},e.next=19,Message.findOne({_id:n});case 19:return y=e.sent,m=[].concat(_toConsumableArray(y.repeat),[f]),e.next=23,Message.updateOne({_id:n},{$set:{repeat:m}});case 23:return u.email&&sendEmail("hi，".concat(u.name,"，你在https://adaxh.site 的留言板有了新的回复～\n\n          ").concat(c.name," 说 ：\n\n          “").concat(o,"”\n        "),u.email,"留言回复通知"),e.next=26,Message.findOne({_id:n});case 26:return b=e.sent,e.next=29,setAllAvatar(b.repeat);case 29:b.repeat=e.sent,r.body={success:!0,data:_objectSpread({},b._doc)},e.next=36;break;case 33:e.prev=33,e.t0=e.catch(1),r.body={success:!1,errorMsg:e.t0};case 36:case"end":return e.stop()}},e,null,[[1,33]])}));return function(e){return r.apply(this,arguments)}}()},routerExports.deleteMsg={method:"post",url:"/deleteMsgById",route:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.body._id,e.prev=1,a=getJWTPayload(r.headers.authorization)){e.next=5;break}throw"token认证失败";case 5:return e.next=7,Message.findOne({_id:n});case 7:return o=e.sent,e.next=10,User.findOne({_id:a._id});case 10:if(s=e.sent){e.next=13;break}throw"会话已过期";case 13:if(o.name===s.name||s.admin)return e.next=16,Message.deleteOne({_id:n});e.next=19;break;case 16:r.body={success:!0},e.next=20;break;case 19:throw"暂无权限";case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(1),r.body={success:!1,errorMsg:e.t0};case 25:case"end":return e.stop()}},e,null,[[1,22]])}));return function(e,r){return t.apply(this,arguments)}}()},routerExports._leaveMsg={method:"post",url:"/leaveMsg",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,o,s,i,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.request.body,n=t.date,a=t.content,o=escapeMessage(a),e.prev=2,s=getJWTPayload(r.headers.authorization)){e.next=6;break}throw"token认证失败";case 6:if(n&&a){e.next=8;break}throw"入参错误";case 8:return e.next=10,User.findOne({_id:s._id},{name:1,avatar:1,email:1});case 10:return i=e.sent,e.next=13,new Message(_objectSpread({name:i.name,date:n,content:o,repeat:[],userId:s._id},i)).save();case 13:if(c=e.sent,/default_avatar/.test(c.avatar))return e.next=17,User.findOne({_id:s._id});e.next=19;break;case 17:u=e.sent,c.avatar=u.avatar;case 19:r.body={success:!0},sendEmail("".concat(i.name,"（").concat(i.email,"）给你留言了：").concat(o),void 0,"留言回复通知"),e.next=26;break;case 23:e.prev=23,e.t0=e.catch(2),r.body={success:!1,errorMsg:e.t0};case 26:case"end":return e.stop()}},e,null,[[2,23]])}));return function(e){return r.apply(this,arguments)}}()},routerExports.getAllMessage={method:"post",url:"/getAllMessage",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,o,s,i,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.request.body,n=t.page,a=void 0===n?1:n,o=t.pageSize,s=void 0===o?10:o,r.body={success:!0},e.next=5,Message.find({}).sort({_id:-1}).skip((a-1)*s).limit(s);case 5:return i=e.sent,e.next=8,Message.find().count();case 8:return c=e.sent,e.next=11,setAllAvatar(i);case 11:u=e.sent,r.body={success:!0,data:u,totalCount:c},e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),r.body={success:!1,errorMsg:e.t0};case 18:case"end":return e.stop()}},e,null,[[0,15]])}));return function(e){return r.apply(this,arguments)}}()},module.exports=routerExports;