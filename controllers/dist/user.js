"use strict";function _objectWithoutProperties(e,r){if(null==e)return{};var t,n=_objectWithoutPropertiesLoose(e,r);if(Object.getOwnPropertySymbols)for(var a=Object.getOwnPropertySymbols(e),o=0;o<a.length;o++)t=a[o],0<=r.indexOf(t)||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t]);return n}function _objectWithoutPropertiesLoose(e,r){if(null==e)return{};for(var t,n={},a=Object.keys(e),o=0;o<a.length;o++)t=a[o],0<=r.indexOf(t)||(n[t]=e[t]);return n}function ownKeys(r,e){var t,n=Object.keys(r);return Object.getOwnPropertySymbols&&(t=Object.getOwnPropertySymbols(r),e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),n.push.apply(n,t)),n}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function asyncGeneratorStep(e,r,t,n,a,o,s){try{var c=e[o](s),u=c.value}catch(e){return void t(e)}c.done?r(u):Promise.resolve(u).then(n,a)}function _asyncToGenerator(c){return function(){var e=this,s=arguments;return new Promise(function(r,t){var n=c.apply(e,s);function a(e){asyncGeneratorStep(n,r,t,a,o,"next",e)}function o(e){asyncGeneratorStep(n,r,t,a,o,"throw",e)}a(void 0)})}}var routerExports={},User=require("./../dbmodel/User"),fs=require("fs"),Base64=require("js-base64").Base64,SinaCloud=require("scs-sdk"),jwt=require("jsonwebtoken"),svgCaptcha=require("svg-captcha"),_require=require("../common/util"),getJWTPayload=_require.getJWTPayload,parseToken=_require.parseToken,reMapError=_require.reMapError,_require2=require("./../dbmodel/User"),findOne=_require2.findOne,secret="secret";function getToken(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return jwt.sign(e,secret,{expiresIn:"1day"})}function callSaveGalleryToBucket(e,r){var a=Buffer(r.replace(/^data:image\/\w+;base64,/,""),"base64");return new Promise(function(t,n){(new SinaCloud.S3).putObject({ACL:"public-read",Bucket:"ada.bucket",Key:"extra/".concat(e.replace(/jpeg+|JPG/g,"jpg")),Body:a},function(e,r){e?n(e):t()})})}routerExports.uploadGallery={method:"post",url:"/uploadGallery",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.request.body,n=t.fileName,a=t.dataUrl,e.prev=1,e.next=4,callSaveGalleryToBucket(n,a);case 4:r.body={success:!0},e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),console.log(e.t0),r.body={success:!1,errorMsg:e.t0};case 11:case"end":return e.stop()}},e,null,[[1,7]])}));return function(e){return r.apply(this,arguments)}}()},routerExports.getCaptcha={method:"post",url:"/getCaptcha",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=svgCaptcha.create({size:4,ignoreChars:"",noise:2}),r.session={},r.session.captcha=t.text,r.body=t.data;case 4:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()},routerExports.setPics={method:"post",url:"/setPics",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.request.body,n=t.type,a=t.binary,e.prev=1,e.next=4,callHandlePic(n,a);case 4:r.body={success:!0},e.next=10;break;case 7:e.prev=7,e.t0=e.catch(1),r.body={success:!1,errorMsg:e.t0};case 10:case"end":return e.stop()}},e,null,[[1,7]])}));return function(e){return r.apply(this,arguments)}}()};var callHandlePic=function(a,r){return new Promise(function(t,n){var e=Buffer(r,"binary");fs.writeFile("./public/resouce/images/".concat(a,".jpg"),e,function(e){null===e?User.findOne({name:"Ada"}).then(function(e){var r;e&&((r=e.pics||{glitchUrl:" ",flyUrl:""})["glitch"===a?"glitchUrl":"flyUrl"]="resouce/imagses/".concat(a,".jpg"),User.updateOne({name:"Ada"},{$set:{pics:_objectSpread({},r)}}).then(function(e){return e?t():n("更新出错")}).catch(function(e){return n(e instanceof Object?JSON.stringify(e):e.toString())}))}).catch(function(e){return n(e instanceof Object?JSON.stringify(e):e.toString())}):n("保存文件时出错"+e instanceof Object?JSON.stringify(e):e.toString())})})};function callIntroduce(){return new Promise(function(r,t){User.findOne({name:"Ada"}).then(function(e){e?r(e.introduce):t("查询失败")}).catch(function(e){return t(e)})})}function callUpdateIntroduce(e){return new Promise(function(r,t){User.updateOne({$set:{introduce:e}}).then(function(e){1===e.ok?r(!0):t("更新失败")}).catch(function(e){return t(e)})})}function callSaveAvatarToBucket(e,r,t){return _callSaveAvatarToBucket.apply(this,arguments)}function _callSaveAvatarToBucket(){return(_callSaveAvatarToBucket=_asyncToGenerator(regeneratorRuntime.mark(function e(r,o,s){var c,t,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c=Buffer(r,"binary"),t=s.split("."),u=/gif+|GIF/.test(t[t.length-1])?"gif":"jpg",e.abrupt("return",new Promise(function(t,n){var a="http://sinacloud.net/ada.bucket/avatar/".concat(s).concat(o,".").concat(u);(new SinaCloud.S3).putObject({ACL:"public-read",Bucket:"ada.bucket",Key:"avatar/".concat(s).concat(o,".").concat(u),Body:c},function(e,r){e?n(e):User.updateOne({_id:o},{$set:{avatar:a}}).then(function(e){return 1===e.n?t({avatar:a,bf:c}):n("头像更新失败")})})}));case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}routerExports.login={method:"post",url:"/login",route:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o,s,c,u,i,p,d,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.request.body,a=n.name,o=n.pwd,s=n.state,(c=new Date).setDate(c.getDate()+2),e.prev=3,e.next=6,User.findOne({name:a});case 6:return u=e.sent,e.next=9,User.findOne({email:a});case 9:if(i=e.sent,u||i){e.next=12;break}throw"账号不存在";case 12:return e.next=14,User.findOne({name:a,password:o});case 14:return p=e.sent,e.next=17,User.findOne({email:a,password:o});case 17:if(d=e.sent,f=p||d){e.next=21;break}throw"账号和密码不匹配";case 21:s&&r.cookies.set("user",Base64.encode(a),{expires:c,httpOnly:!1,overwrite:!1}),r.cookies.set("token",getToken({_id:f._id}),{expires:c,httpOnly:!1,overwrite:!1}),delete f._doc.password,f.name=a,console.log(a+" 上线"),r.body=_objectSpread(_objectSpread({success:!0},f._doc),{},{token:getToken({_id:f._id})}),e.next=33;break;case 29:e.prev=29,e.t0=e.catch(3),console.log("error",e.t0),r.body={success:!1,errorMsg:e.t0};case 33:case"end":return e.stop()}},e,null,[[3,29]])}));return function(e,r){return t.apply(this,arguments)}}()},routerExports.getUserInfoByToken={method:"post",url:"/getUserInfoByToken",route:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(n=r.headers.authorization)&&"null"!==n){e.next=4;break}return e.abrupt("return",r.body={success:!0,user:{isLogin:!1}});case 4:if(a=getJWTPayload(n)){e.next=7;break}throw"token认证失败";case 7:return e.next=9,User.findOne({_id:a._id});case 9:delete(o=e.sent)._doc.password,console.log(o.name+" 重新连接"),r.body={success:!0,user:o},e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),r.body={success:!1,errorMsg:e.t0};case 18:case"end":return e.stop()}},e,null,[[0,15]])}));return function(e,r){return t.apply(this,arguments)}}()},routerExports.introduce={method:"post",url:"/introduce",route:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,callIntroduce();case 3:n=e.sent,r.body={success:!0,introduce:String(n)},e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.body={success:!1,errorMsg:e.t0};case 10:case"end":return e.stop()}},e,null,[[0,7]])}));return function(e,r){return t.apply(this,arguments)}}()},routerExports.updateIntroduce={method:"post",url:"/updateIntroduce",route:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.request.body.introduce,e.prev=1,a=r.headers.authorization,o=parseToken(a),o._id,e.next=7,callUpdateIntroduce(n);case 7:r.body={success:!0},e.next=13;break;case 10:e.prev=10,e.t0=e.catch(1),r.body={success:!1,errorMsg:e.t0};case 13:case"end":return e.stop()}},e,null,[[1,10]])}));return function(e,r){return t.apply(this,arguments)}}()},routerExports.getAvatar={method:"post",url:"/get-avatar",route:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.request.body.name,a=JSON.parse(Base64.decode(n)).name,e.next=4,User.findOne({name:a}).then(function(e){r.body=e?{success:!0,data:e.avatar}:{success:!1,errorMsg:"无法获取头像"}}).catch(function(e){r.body={success:!1,errorMsg:error}});case 4:case"end":return e.stop()}},e)}));return function(e,r){return t.apply(this,arguments)}}()},routerExports.setAvatar={method:"post",url:"/set-avatar",route:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o,s,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.request.body,a=n.avatar,n.name,o=n.fileName,e.prev=1,s=r.headers.authorization,c=parseToken(s),e.next=6,callSaveAvatarToBucket(a,c._id,o);case 6:u=e.sent,r.body={success:!0,src:u},e.next=13;break;case 10:e.prev=10,e.t0=e.catch(1),r.body={success:!1,errorMsg:e.t0};case 13:case"end":return e.stop()}},e,null,[[1,10]])}));return function(e,r){return t.apply(this,arguments)}}()},routerExports.register={method:"post",url:"/register",route:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o,s,c,u,i,p;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.body,a=n.name,o=n.pwd,s=n.captchaCode,c=n.email,e.prev=1,u=r.session.captcha){e.next=5;break}throw"服务器繁忙，请重试";case 5:if(u.toLowerCase()!==s.toLowerCase())throw"验证码不正确";e.next=7;break;case 7:return e.next=9,User.findOne({name:a});case 9:if(e.sent)throw"用户已存在";e.next=12;break;case 12:return e.next=14,User.findOne({email:c});case 14:if(i=e.sent,c&&i)throw"该邮箱已注册";e.next=17;break;case 17:return e.next=19,new User({name:a,password:o,email:c}).save();case 19:delete(p=e.sent)._doc.password,r.body=_objectSpread({success:!0},p._doc),e.next=27;break;case 24:e.prev=24,e.t0=e.catch(1),r.body={success:!1,errorMsg:e.t0};case 27:case"end":return e.stop()}},e,null,[[1,24]])}));return function(e,r){return t.apply(this,arguments)}}()},routerExports.updateUserInfo={method:"post",url:"/updateUserInfo",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.request.body,n=t._id,a=_objectWithoutProperties(t,["_id"]),e.prev=1,a.email)return e.next=5,User.findOne({_id:n});e.next=12;break;case 5:if((o=e.sent)&&o.email!==a.email)return e.next=9,User.findOne({email:a.email});e.next=12;break;case 9:if(e.sent)throw"该邮箱已被注册";e.next=12;break;case 12:if(a.name)return e.next=15,User.findOne({_id:n});e.next=23;break;case 15:if((s=e.sent)&&s.name!==a.name)return e.next=19,User.findOne({name:a.name});e.next=22;break;case 19:if(e.sent)throw"用户名已存在";e.next=22;break;case 22:a.originName=s.name;case 23:return"admin"in a&&delete a.admin,e.next=26,User.updateOne({_id:n},{$set:a});case 26:r.body={success:!0},e.next=32;break;case 29:e.prev=29,e.t0=e.catch(1),r.body={success:!1,errorMsg:e.t0};case 32:case"end":return e.stop()}},e,null,[[1,29]])}));return function(e){return r.apply(this,arguments)}}()},module.exports=routerExports;