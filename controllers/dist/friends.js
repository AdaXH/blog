"use strict";function _objectWithoutProperties(e,r){if(null==e)return{};var t,n=_objectWithoutPropertiesLoose(e,r);if(Object.getOwnPropertySymbols)for(var o=Object.getOwnPropertySymbols(e),i=0;i<o.length;i++)t=o[i],0<=r.indexOf(t)||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t]);return n}function _objectWithoutPropertiesLoose(e,r){if(null==e)return{};for(var t,n={},o=Object.keys(e),i=0;i<o.length;i++)t=o[i],0<=r.indexOf(t)||(n[t]=e[t]);return n}function asyncGeneratorStep(e,r,t,n,o,i,s){try{var a=e[i](s),u=a.value}catch(e){return void t(e)}a.done?r(u):Promise.resolve(u).then(n,o)}function _asyncToGenerator(a){return function(){var e=this,s=arguments;return new Promise(function(r,t){var n=a.apply(e,s);function o(e){asyncGeneratorStep(n,r,t,o,i,"next",e)}function i(e){asyncGeneratorStep(n,r,t,o,i,"throw",e)}o(void 0)})}}var routerExports={},FriendShip=require("./../dbmodel/FriendShip"),User=require("./../dbmodel/User"),_require=require("../common/util"),parseToken=_require.parseToken,sendEmail=_require.sendEmail;routerExports.queryFriends={method:"get",url:"/queryFriends",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,FriendShip.find({});case 3:t=e.sent,r.body={success:!0,data:t},e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.body={success:!1,errorMsg:e.t0};case 10:case"end":return e.stop()}},e,null,[[0,7]])}));return function(e){return r.apply(this,arguments)}}()},routerExports.verifyFriend={method:"post",url:"/verifyFriend",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.request.body,n=t._id,o=_objectWithoutProperties(t,["_id"]),e.next=4,FriendShip.findOne({_id:n});case 4:if(i=e.sent){e.next=7;break}throw"找不到这个友情链接哦";case 7:return o.verify&&!i.verify&&i.email&&sendEmail("hi~, 你在 https://adaxh.site 提交的友情链接：".concat(i.link,"，已经通过申请，欢迎回访！"),i.email),e.next=10,FriendShip.updateOne({_id:n},{$set:o});case 10:r.body={success:!0},e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),r.body={success:!1,errorMsg:e.t0};case 16:case"end":return e.stop()}},e,null,[[0,13]])}));return function(e){return r.apply(this,arguments)}}()},routerExports.addFriend={method:"post",url:"/addFriend",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.request.body,n=t.link,e.next=5,FriendShip.findOne({link:n});case 5:if(!(o=e.sent)){e.next=12;break}if(o&&!o.verify)throw"友链已提交过了，您可以前往首页通过“聊骚吗”催一下";e.next=9;break;case 9:throw"这个友情链接已存在啦";case 12:return delete t.verify,e.next=15,new FriendShip(t).save();case 15:r.body={success:!0},sendEmail("有新的链接申请！".concat(JSON.stringify(t))),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(0),r.body={success:!1,errorMsg:e.t0};case 22:case"end":return e.stop()}},e,null,[[0,19]])}));return function(e){return r.apply(this,arguments)}}()},routerExports.deleteFriend={method:"post",url:"/deleteFriend",route:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.request.body._id,e.next=4,FriendShip.deleteOne({_id:t});case 4:r.body={success:!0},e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.body={success:!1,errorMsg:e.t0};case 10:case"end":return e.stop()}},e,null,[[0,7]])}));return function(e){return r.apply(this,arguments)}}()},module.exports=routerExports;