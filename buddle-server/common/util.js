const jwt=require("jsonwebtoken"),request=require("request"),{HOST,BASE_MIDDLEWARES}=require("./constant"),moment=require("moment-timezone"),{FILTER_URL}=require("./constant"),fs=require("fs");moment.tz.setDefault("Asia/Shanghai");const{SMTPClient}=require("emailjs"),env=getEnv();function getJWTPayload(e){if(e)return jwt.verify(e,"secret")}function getEnv(){try{return process.argv[process.argv.length-1].replace(/--env=/,"")}catch(e){return console.log("get env error",e),"undefined"}}async function sendToDing(e){const n=require("https");var t,r;await async function(e,o){const t=e.split("/robot/"),s={path:`/robot/${t[1]}`,hostname:t[0].replace("https://",""),method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"}};return new Promise((t,r)=>{const e=n.request(s,e=>{e.on("data",e=>t(JSON.parse(e)))});e.on("error",e=>r(e.message)),e.write(o),e.end()})}("https://oapi.dingtalk.com/robot/send?access_token=0b146a047fbede98aaa8c474aaaa30b954c3e1c912977bfff23948ba85491c25",([{title:t="通知",content:r="content"}]=[e],JSON.stringify({msgtype:"markdown",markdown:{title:"tip",text:`**${t}** \n > ${r}`}})))}exports.getJWTPayload=getJWTPayload,exports.request2=e=>new Promise((o,s)=>{request(e,(e,t,r)=>{r&&o(r),e&&s(e)})}),exports.parseToken=e=>{try{var t=getJWTPayload(e);if(!t)throw"会话过期，请重新登陆";return t}catch(e){throw console.log("error",e),e}},exports.sendEmail=async(e,t="18668465750@163.com",r="友情链接通知")=>{try{if("development"===env)return;const o=new SMTPClient({user:"adaxh@qq.com",password:"nvpaltxtmusbchie",host:"smtp.qq.com",ssl:!0});o.send({text:e,from:"adaxh@qq.com",to:t,subject:r},(e,t)=>{console.log(e||t)}),await sendToDing({title:r,content:e})}catch(e){console.log("err",e)}},exports.randomCode=t=>{if(!t)return"";const r=[];for(let e=0;e<t;e++)r.push(Math.floor(10*Math.random()));return r.join("")},exports.getRandomLength=e=>Math.floor(Math.random()*e),exports.escapeData=e=>e.replace(/<input\stype="text"\sdata-formula="e=mc\^2"\sdata-link="quilljs\.com"\sdata-video="Embed\sURL"\splaceholder="Embed\sURL">/g,"").replace(/<\/?script>+|傻逼+|爸爸+|你爸+|SB+|sB+|sb+|操+|你妈+|我草+|我艹/g,"**"),exports.setCookieWithHost=(t,r,o,s={})=>{const n=new Date;n.setDate(n.getDate()+2),HOST.forEach(e=>{t.set(r,o,{...s,expires:n,httpOnly:!1,overwrite:!1,domain:e})})},exports.isTarget=(e,t)=>-1!==Object.prototype.toString.call(e).indexOf(t),exports.isJSON=e=>{try{return JSON.parse(e),!0}catch(e){return!1}},exports.needFilter=e=>{if(!e)return!1;for(const t of FILTER_URL)if(-1!==e.indexOf(t))return!0;return!1},exports.getTime=()=>moment().format("MM-DD HH:mm:ss"),exports.readFile=e=>new Promise((r,o)=>{fs.stat(e,(e,t)=>{e?o(e):r(t)})}),exports.reMapError=e=>e instanceof Object?/JsonWebTokenError+|TokenExpiredError/.test(JSON.stringify(e))?"会话已过期，请重新登录验证":JSON.stringify(e):e.toString(),exports.getEnv=getEnv,exports.registerBaseMiddleware=(t,r)=>(BASE_MIDDLEWARES.forEach(e=>{e=e(t,...r);Array.isArray(e)?t.use(...e):t.use(e)}),t),exports.getClientIP=e=>{let t=e.headers["x-forwarded-for"]||e.ip||e.connection.remoteAddress||e.socket.remoteAddress||e.connection.socket.remoteAddress||"";return t=t&&t.replace("::ffff:",""),t};