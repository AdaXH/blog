const User=require("../dbmodel/User"),filterKey=["name","avatar","_id","userId","originName","email"];async function setAllAvatar(e){for(const d of e){var{repeat:a,toRepeatUserId:r}=d,{avatar:t,name:i,userId:n,originName:s,email:o,toRepeatUser:u}=await queryUser(d);a&&a.length&&(a=await setAllAvatar(a),d._doc.repeat=a),r&&(d._doc.toRepeatUserVo=await queryUser({userId:r})),d._doc={...d._doc,avatar:t,name:i,userId:n,originName:s,email:o,toRepeatUser:u}}return e}async function queryUser(e){var{userId:a,name:r,originName:t,toRepeatUser:i}=e;if(!a||"null"==a)return e;let n=await User.findOne({[a?"_id":"name"]:a||r}),s={};if(i&&i.userId&&(s=await User.findOne({_id:i.userId},filterKey.join(" "))),!n&&t&&(n=await User.findOne({originName:t})),!n)return{name:"账号已被注销",userId:null};if(n){var{originName:o,avatar:u,_id:e,name:a,email:t}=n;return{avatar:u,name:a,userId:e,originName:o,email:t,toRepeatUser:s||i}}return{name:r}}module.exports={setAllAvatar:setAllAvatar,queryUser:queryUser};