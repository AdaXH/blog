const Message=require("./../dbmodel/Message"),User=require("./../dbmodel/User"),{getJWTPayload,sendEmail,escapeData,getClientIP}=require("../common/util"),{queryUser,setAllAvatar}=require("../common/apiPrefix"),routerExports={deleteInnerRepeat:{method:"post",url:"/deleteInnerRepeat",route:async(a,e)=>{const{_id:t,_parent_id:r,toRepeatUserId:s}=a.request.body;try{var i=getJWTPayload(a.headers.authorization);if(!i)throw"会话过期，请重新登陆";var d=await User.findOne({_id:i._id});if(!d)throw"当前用户不存在或会话已过期";if(s!==i._id&&!d.admin)throw"只能删除自己的回复";const n=await Message.findOne({_id:r});if(!n)throw"该条回复不存在";var o=n.repeat.filter(e=>e._id!=t);await Message.updateOne({_id:r},{$set:{repeat:[...o]}}),a.body={success:!0,data:o}}catch(e){a.body={success:!1,errorMsg:e}}}},_repeatMsg:{method:"post",url:"/repeatmsg",route:async a=>{var{_id:e,toRepeat:t,info:r,toRepeatId:s}=a.request.body;try{var i=getJWTPayload(a.headers.authorization);if(!i)throw"会话过期，请重新登陆";var d=await User.findOne({_id:i._id});if(!d)throw"当前用户不存在";if(i._id===s)throw"请勿回复自己";var o=await queryUser({userId:s,name:t}),{name:n,avatar:l,eamil:c}=d,u={userId:i._id,toRepeat:t,date:Date.now(),info:escapeData(r),name:n,avatar:l,eamil:c,toRepeatUser:o},p=[...(await Message.findOne({_id:e})).repeat,u];await Message.updateOne({_id:e},{$set:{repeat:p}}),o.email&&sendEmail(`hi，${o.name}，你在https://adaxh.site 的留言板有了新的回复～\n${d.name} 说 ：\n“${r}”
        `,o.email,"留言回复通知");const m=await Message.findOne({_id:e});m.repeat=await setAllAvatar(m.repeat),a.body={success:!0,data:{...m._doc}}}catch(e){console.log("error",e),a.body={success:!1,errorMsg:e}}}},deleteMsg:{method:"post",url:"/deleteMsgById",route:async(a,e)=>{var{_id:t}=a.request.body;try{var r=getJWTPayload(a.headers.authorization);if(!r)throw"会话过期，请重新登陆";var s=await Message.findOne({_id:t}),i=await User.findOne({_id:r._id});if(!i)throw"会话已过期";if(s.name!==i.name&&!i.admin)throw"暂无权限";await Message.deleteOne({_id:t}),a.body={success:!0}}catch(e){a.body={success:!1,errorMsg:e}}}},_leaveMsg:{method:"post",url:"/leaveMsg",route:async t=>{const{date:r,content:s,quickReply:i=!1}=t.request.body;var d,o=escapeData(s),n=getClientIP(t);try{let e={name:"陌生人"},a={_id:"null"};if(!i){if(a=getJWTPayload(t.headers.authorization),!a)throw"会话过期，请重新登陆";if(!r||!s)throw"入参错误";e=await User.findOne({_id:a._id},{name:1,avatar:1,email:1})}if(!e._id){var l=await Message.findOne({ip:n});if(l){const{ip:u,date:r}=l;if(u===n)if(Date.now()-new Date(Number(r)).getTime()<=864e5)throw"未登录一天只能回复一条，建议先登陆"}}const c=await new Message({name:e.name,date:r,content:o,repeat:[],userId:a._id,...e,ip:n}).save();/default_avatar/.test(c.avatar)&&(d="null"===a._id?{avatar:"/upload/user_avatar/default_avatar.jpg"}:await User.findOne({_id:a._id}),c.avatar=d.avatar),t.body={success:!0},sendEmail(`${e.name}（${e.email}）给你留言了：${o}`,void 0,"留言回复通知")}catch(e){console.log("error",e),t.body={success:!1,errorMsg:e}}}},_leaveMsgv2:{method:"post",url:"/leaveMsgv2",route:async t=>{var r,{date:s,content:i,quickReply:d=!1}=t.request.body,o=escapeData(i);try{let e={name:"陌生人"},a={_id:"null"};if(!d){if(a=getJWTPayload(t.headers.authorization),!a)throw"会话过期，请重新登陆";if(!s||!i)throw"入参错误";e=await User.findOne({_id:a._id},{name:1,avatar:1,email:1})}const n=await new Message({name:e.name,date:s,content:o,repeat:[],userId:a._id,...e}).save();/default_avatar/.test(n.avatar)&&(r="null"===a._id?{avatar:"/upload/user_avatar/default_avatar.jpg"}:await User.findOne({_id:a._id}),n.avatar=r.avatar),t.body={success:!0,data:n},sendEmail(`${e.name}（${e.email}）给你留言了：${o}`,void 0,"留言回复通知")}catch(e){t.body={success:!1,errorMsg:e}}}},getAllMessage:{method:"post",url:"/getAllMessage",route:async a=>{try{var{page:e=1,pageSize:t=10}=a.request.body;a.body={success:!0};var r=await Message.find({}).sort({_id:-1}).skip((e-1)*t).limit(t),s=await Message.find().count();const i=await setAllAvatar(r);i.forEach(e=>{e.repeat&&(e.repeat=e.repeat.reverse())}),a.body={success:!0,data:i,totalCount:s}}catch(e){a.body={success:!1,errorMsg:e}}}}};module.exports=routerExports;