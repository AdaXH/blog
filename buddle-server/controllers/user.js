const routerExports={},User=require("./../dbmodel/User"),fs=require("fs"),Base64=require("js-base64").Base64,SinaCloud=require("scs-sdk"),jwt=require("jsonwebtoken"),svgCaptcha=require("svg-captcha"),{getJWTPayload,parseToken,randomCode,sendEmail,request2,setCookieWithHost}=require("../common/util"),querystring=require("querystring"),secret="secret";function getToken(e={}){return jwt.sign(e,secret,{expiresIn:"1day"})}function callSaveGalleryToBucket(r,e){const a=Buffer.from(e.replace(/^data:image\/\w+;base64,/,""),"base64");return new Promise((s,t)=>{const e=new SinaCloud.S3;e.putObject({ACL:"public-read",Bucket:"ada.bucket",Key:`extra/${r.replace(/jpeg+|JPG/g,"jpg")}`,Body:a},function(e,r){e?t(e):s()})})}routerExports.uploadGallery={method:"post",url:"/uploadGallery",route:async r=>{var{fileName:e,dataUrl:s}=r.request.body;try{await callSaveGalleryToBucket(e,s),r.body={success:!0}}catch(e){console.log(e),r.body={success:!1,errorMsg:e}}}},routerExports.getCaptcha={method:"post",url:"/getCaptcha",route:async e=>{var r=svgCaptcha.create({size:4,ignoreChars:"",noise:2});e.session={},e.session.captcha=r.text,e.body=r.data}},routerExports.setPics={method:"post",url:"/setPics",route:async r=>{var{type:e,binary:s}=r.request.body;try{await callHandlePic(e,s),r.body={success:!0}}catch(e){r.body={success:!1,errorMsg:e}}}};const callHandlePic=(a,r)=>new Promise((s,t)=>{var e=Buffer.from(r,"binary");fs.writeFile(`./public/resouce/images/${a}.jpg`,e,e=>{null===e?User.findOne({name:"Ada"}).then(e=>{if(e){const r=e.pics||{glitchUrl:" ",flyUrl:""};r["glitch"===a?"glitchUrl":"flyUrl"]=`resouce/imagses/${a}.jpg`,User.updateOne({name:"Ada"},{$set:{pics:{...r}}}).then(e=>e?s():t("更新出错")).catch(e=>t(e instanceof Object?JSON.stringify(e):e.toString()))}}).catch(e=>t(e instanceof Object?JSON.stringify(e):e.toString())):t("保存文件时出错"+e instanceof Object?JSON.stringify(e):e.toString())})});function callIntroduce(){return new Promise((r,s)=>{User.findOne({name:"Ada"}).then(e=>{e?r(e.introduce):s("查询失败")}).catch(e=>s(e))})}async function callSaveAvatarToBucket(e,o,r){const i=Buffer.from(e,"binary");e=r.split(".");const n=/gif+|GIF/.test(e[e.length-1])?"gif":"jpg";return new Promise((s,t)=>{const a=`http://sinacloud.net/ada.bucket/avatar/${r}${o}.${n}`,e=new SinaCloud.S3;e.putObject({ACL:"public-read",Bucket:"ada.bucket",Key:`avatar/${r}${o}.${n}`,Body:i},function(e,r){e?t(e):User.updateOne({_id:o},{$set:{avatar:a}}).then(e=>1===e.n?s({avatar:a,bf:i}):t("头像更新失败"))})})}routerExports.login={method:"post",url:"/login",route:async(r,e)=>{var{name:s,pwd:t}=r.request.body;try{var{cookies:a}=r,o=await User.findOne({name:s}),i=await User.findOne({email:s});if(!o&&!i)throw"账号不存在";var n=await User.findOne({name:s,password:t}),d=await User.findOne({email:s,password:t});const c=n||d;if(!c)throw"账号和密码不匹配";setCookieWithHost(a,"user",Base64.encode(s)),setCookieWithHost(a,"token",getToken({_id:c._id})),delete c._doc.password,console.log(s+" 上线"),await User.updateOne({name:c.name},{$set:{lastLoginTime:Date.now()}}),r.body={success:!0,...c._doc}}catch(e){console.log("error",e),r.body={success:!1,errorMsg:e}}}},routerExports.getUserInfoByToken={method:"post",url:"/getUserInfoByToken",route:async(r,e)=>{try{var{headers:{authorization:s}}=r;if(!s||"null"===s)return r.body={success:!0,user:{isLogin:!1}};var t=getJWTPayload(s);if(!t)throw"会话过期，请重新登陆";var a=t._id?"_id":"qqUserId";const i=["name","avatar","_id","userId","admin","superAdmin","originName","email"];var o=await User.findOne({[a]:t[a]},i.join(" "));console.log(o.name+" 重新连接"),await User.updateOne({_id:t._id},{$set:{lastLoginTime:Date.now()}}),r.body={success:!0,user:o}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.introduce={method:"post",url:"/introduce",route:async(r,e)=>{try{var s=await callIntroduce();r.body={success:!0,introduce:String(s)}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.getAvatar={method:"post",url:"/get-avatar",route:async(r,e)=>{var{name:s}=r.request.body,s=JSON.parse(Base64.decode(s)).name;await User.findOne({name:s}).then(e=>{r.body=e?{success:!0,data:e.avatar}:{success:!1,errorMsg:"无法获取头像"}}).catch(e=>{r.body={success:!1,errorMsg:e}})}},routerExports.setAvatar={method:"post",url:"/set-avatar",route:async(r,e)=>{var{avatar:s,fileName:t}=r.request.body;try{var{headers:{authorization:a}}=r,o=await callSaveAvatarToBucket(s,parseToken(a)._id,t);r.body={success:!0,src:o}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.register={method:"post",url:"/register",route:async r=>{const{name:e,pwd:s,email:t,emailCode:a}=r.request.body;try{const{session:{registerEmailCode:i}}=r;if(!i)throw"服务器繁忙，请用qq登陆~";if(a.toLowerCase()!==i.toLowerCase())throw"验证码不正确";if(await User.findOne({name:e}))throw"用户已存在";var o=await User.findOne({email:t});if(t&&o)throw"该邮箱已注册";const n=await new User({name:e,password:s,email:t}).save();delete n._doc.password,r.body={success:!0,...n._doc}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.updateUserInfo={method:"post",url:"/updateUserInfo",route:async r=>{const{_id:e,...s}=r.request.body;try{var{bindEmailCode:t,email:a,password:o,name:i}=s;if(o&&o.length&&o.length<=6)throw"密码长度不能低于6位";if(a){var n=await User.findOne({_id:e});if(n&&n.email!==a){if(await User.findOne({email:a}))throw"该邮箱已被注册";if(!t||t!==r.session.bindEmailCode)throw"验证码不正确"}}if(i){var d=await User.findOne({_id:e});if(d&&d.name!==i)if(await User.findOne({name:i}))throw"用户名已存在";s.originName=d.name}"admin"in s&&delete s.admin,"superAdmin"in s&&delete s.superAdmin,await User.updateOne({_id:e},{$set:s}),r.body={success:!0}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.queryUsers={method:"post",url:"/queryUsers",route:async r=>{try{var e=await User.find({},{name:1,lastLoginTime:1,email:1,avatar:1,admin:1}).sort({lastLoginTime:-1});r.body={success:!0,data:e}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.changeUserStatus={method:"post",url:"/changeUserStatus",route:async r=>{var{request:{body:{userId:e,status:s}},headers:{authorization:t}}=r;try{var a=getJWTPayload(t),{superAdmin:o,admin:i}=await User.findOne({_id:a._id},{admin:1,superAdmin:1});if(!i||!o)throw"暂无权限";await User.updateOne({_id:e},{$set:{admin:s}}),r.body={success:!0}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.deleteUser={method:"post",url:"/deleteUser",route:async r=>{var{request:{body:{userId:e}},headers:{authorization:s}}=r;try{var t=getJWTPayload(s),{superAdmin:a,admin:o}=await User.findOne({_id:t._id});if(!o||!a)throw"暂无权限";await User.deleteOne({_id:e}),r.body={success:!0}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.sendCodeToEmail={method:"post",url:"/sendCodeToEmail",route:async r=>{try{var{request:{body:{email:e}}}=r,s=await User.findOne({email:e});if(!s)throw"该邮箱未注册，如果您注册时没有绑定邮箱，请找管理员帮您绑定";var t=randomCode(4);r.session.emailCode=t,sendEmail(`hi~ ${s.name}：\n这是您在https://adaxh.site\n找回密码的验证码：${t}\n请妥善保管，以防泄漏`,e,"找回密码-验证码"),r.body={success:!0}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.getEmailCode={method:"post",url:"/getEmailCode",route:async r=>{try{var{request:{body:{email:e}}}=r;if(await User.findOne({email:e}))throw"该邮箱已经注册～";var s=randomCode(4);r.session.registerEmailCode=s,sendEmail(`hi~ ${e}：\n这是您在https://adaxh.site\n绑定邮箱的验证码：${s}\n请妥善保管，以防泄漏`,e,"绑定邮箱-验证码"),r.body={success:!0}}catch(e){r.body={success:!1,errorMsg:e,error:e}}}},routerExports.getCode={method:"post",url:"/getCode",route:async r=>{try{var{request:{body:{email:s}}}=r;let e=await User.findOne({email:s});if(e)throw"该邮箱已经被别人绑定了";var{headers:{authorization:t}}=r,a=parseToken(t);e=await User.findById(a._id);var o=randomCode(4);r.session.bindEmailCode=o,sendEmail(`hi~ ${e.name}：\n这是您在https://adaxh.site\n绑定邮箱的验证码：${o}\n请妥善保管，以防泄漏`,s,"绑定邮箱-验证码"),r.body={success:!0}}catch(e){r.body={success:!1,errorMsg:e,error:e}}}},routerExports.resetPassword={method:"post",url:"/resetPassword",route:async r=>{try{var{request:{body:{code:e,pwd:s,email:t}}}=r;if(e!==r.session.emailCode)throw"验证码不正确";if(!await User.findOne({email:t}))throw"用户已不存在!";await User.updateOne({email:t},{$set:{password:s}}),r.body={success:!0}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.qq_login={url:"/qq_login",method:"get",route:async r=>{try{var{query:e,cookies:s}=r,t=await request2(`https://graph.qq.com/oauth2.0/me?${querystring.stringify(e,"&","=")}`),{client_id:a,openid:o,unionid:i}=JSON.parse(t),n=await request2(`
      https://graph.qq.com/user/get_user_info?${querystring.stringify({access_token:e.access_token,appid:a,openid:o,unionid:i},"&","=")}`),d=JSON.parse(n);const m={qqUserId:o,unionid:i,name:d.nickname,avatar:d.figureurl_qq};var c=await User.findOne({qqUserId:o}),u=await User.find({name:d.nickname},{name:1}).count();u&&(m.name+=""+u),c||await new User({...m,lastLoginTime:Date.now()}).save();var l=await User.findOne({qqUserId:o})||d;setCookieWithHost(s,"user",Base64.encode(d.nickname)),setCookieWithHost(s,"token",getToken({_id:l._id})),r.body={...l,success:!0}}catch(e){r.body={error:e,success:!1}}}},module.exports=routerExports;