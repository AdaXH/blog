const Dynamic=require("./../dbmodel/Dynamic"),User=require("./../dbmodel/User"),Customer=require("../dbmodel/Customer"),SinaCloud=require("scs-sdk"),accessKey=require("../bucketConfig").accessKey,{getJWTPayload}=require("../common/util"),routerExports={};function callSetDynamicImgToBucket(c,e,t=""){const s=Buffer.from(e.replace(/^data:image\/\w+;base64,/,""),"base64"),o=new SinaCloud.S3;return new Promise((a,r)=>{var e;/ada.bucket/.test(t)&&([e]=t.replace("http://sinacloud.net/ada.bucket/","").split("?KID"),o.deleteObject({Bucket:"ada.bucket",Key:e},function(e){e&&r("")})),o.putObject({ACL:"public-read",Bucket:"ada.bucket",Key:`dynamic_img/${c.replace(/jpeg+|JPG/g,"jpg").replace(/GIF/g,"gif")}`,Body:s},function(e,t){e?r(e):a(`http://sinacloud.net/ada.bucket/dynamic_img/${c.replace(/jpeg+|JPG/g,"jpg").replace(/GIF/g,"gif")}${accessKey}`)})})}function callDeleteDynamicMsg(r,c){return new Promise((t,a)=>{Dynamic.findOne({_id:c}).then(e=>{e&&(e=e.msg.filter(e=>String(e._id)!==String(r)),Dynamic.updateOne({_id:c},{$set:{msg:e}}).then(e=>1===e.ok?t(!0):a("删除失败")))}).catch(e=>a(e instanceof Object?JSON.stringify(e):e.toString()))})}routerExports.upvote={method:"post",url:"/upvoteDynamic",route:async(t,e)=>{var{_id:a}=t.request.body;try{var r=await Dynamic.findOne({_id:a});await Dynamic.updateOne({_id:a},{$set:{upvote:(r.upvote||0)+1}}),t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},routerExports.cancelUpvote={method:"post",url:"/cancelUpvote",route:async(t,e)=>{var{_id:a}=t.request.body;try{var r=await Dynamic.findOne({_id:a});await Dynamic.updateOne({_id:a},{$set:{upvote:1<r.upvote?r.upvote-1:1}}),t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},routerExports.getDynamic={method:"get",url:"/getDynamic",route:async(t,e)=>{try{const r=[...await Dynamic.find()].reverse().map(e=>{let t={};return t=e._doc?{...e._doc,img:e._doc.img?e._doc.img.replace(/jpeg+|JPG/g,"jpg").replace(/GIF/g,"gif"):""}:{...e,img:e.img?e.img.replace(/jpeg+|JPG/g,"jpg").replace(/GIF/g,"gif"):""},t});var a=await Customer.findOne({});a&&a.number&&await Customer.updateOne({},{$set:{number:a.number+1}}),t.body={success:!0,data:r.sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime())}}catch(e){t.body={success:!1,errorMsg:e}}}},routerExports.setDynamicImg={method:"post",url:"/setDynamicImg",route:async t=>{var{name:e,dataUrl:a,img:r}=t.request.body;try{if(!a)return void(t.body={success:!0});var c=await callSetDynamicImgToBucket(e,a,r);t.body={success:!0,img:c}}catch(e){t.body={success:!1,errorMsg:e}}}},routerExports.discussDynamic={method:"post",url:"/discussDynamic",route:async(t,e)=>{var{_id:a,msg:r,name:c}=t.request.body;try{var s=getJWTPayload(t.headers.authorization);if(!s)throw"会话过期，请重新登陆";if(!a||!r||!c)throw"入参错误";var o=await Dynamic.findOne({_id:a}),i=await User.findOne({_id:s._id});const u=o.msg;var d=u.concat([{...r,name:i.name}]);await Dynamic.updateOne({_id:a},{$set:{msg:d}});var n=await Dynamic.findById(a);t.body={success:!0,data:n}}catch(e){t.body={success:!1,errorMsg:e}}}},routerExports.deleDynamic={method:"post",url:"/deleteDynamic",route:async(t,e)=>{var{_id:a}=t.request.body;try{await Dynamic.deleteOne({_id:a}),t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},routerExports.addDynamic={method:"post",url:"/addDynamic",route:async(t,e)=>{var{title:a,content:r,upvote:c,date:s,img:o}=t.request.body;try{await new Dynamic({title:a,content:r,upvote:c,date:s,img:o}).save();var i=await Dynamic.find();t.body={success:!0,data:i}}catch(e){t.body={success:!1,errorMsg:e}}}},routerExports.updateDynamic={method:"post",url:"/updateDynamic",route:async(t,e)=>{var{body:a}=t.request;try{const{_id:c,...s}=a;var r=await Dynamic.updateOne({_id:c},{$set:s});t.body=0!==r.n}catch(e){t.body=!1}}},routerExports.deleteDynamicMsg={method:"post",url:"/deleteDynamicMsg",route:async(t,e)=>{var{_id:a,msgId:r}=t.request.body;try{await callDeleteDynamicMsg(a,r),t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},module.exports=routerExports;