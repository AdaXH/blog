const Article=require("./../dbmodel/Article"),User=require("./../dbmodel/User"),{parseToken,reMapError,sendEmail,escapeData,getClientIP}=require("../common/util"),{setAllAvatar}=require("../common/apiPrefix"),routerExports={deleteArticle:{method:"post",url:"/deleteArticle",route:async(t,e)=>{var{request:{body:{_id:a}}}=t;try{if(null===await Article.findByIdAndDelete({_id:a}))throw"删除失败，文章已不存在";t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},queryArticleById:{method:"post",url:"/queryArticleById",route:async(t,e)=>{var{_id:a}=t.request.body;try{const o=await Article.findOne({_id:a});var{message:r}=o;const c=await setAllAvatar(r);var{year:s,date:i,time:d="0:0:0"}=o;/-/.test(i)&&(o.date=new Date(`${s}-${i}/${d}`)),t.body={success:!0,data:{...o._doc,message:c.reverse()}}}catch(e){console.log("error",e),t.body={success:!1,errorMsg:reMapError(e)}}}},saveArticle:{method:"post",url:"/saveArticle",route:async(t,e)=>{var{date:a,year:r,summary:s,type:i,time:d,title:o="title",abstract:c}=t.request.body;try{if(!(await new Article({time:d,date:a,year:r,summary:s,type:i,viewer:0,title:o,abstract:c}).save())._id)throw"保存失败";t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},updateArticle:{method:"post",url:"/updateArticleViewerById",route:async(t,e)=>{var{_id:a}=t.request.body;try{var r=await Article.findOne({_id:a});if(!r)throw"文章不存在";await Article.updateOne({_id:a},{$set:{viewer:r.viewer+1}}),t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},updateArticleById:{method:"post",url:"/updateArticleById",route:async(t,e)=>{var{_id:a,summary:r,title:s="",type:i,abstract:d}=t.request.body;try{await Article.updateOne({_id:a},{$set:{summary:r,type:i,title:s,abstract:d}}),t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},deleteArticleMsg:{method:"post",url:"/deleteArticleMsg",route:async(t,e)=>{const{articleId:a,messageId:r,userId:s}=t.request.body;try{var{headers:{authorization:i}}=t,{_id:d}=parseToken(i);if(!(await User.findById(d)).admin&&s!==d)throw"无权限删除";const o=(await Article.findById(a)).message||[];await Article.updateOne({_id:a},{$set:{message:o.filter(e=>e._id!=r)}}),t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},deleteArticleReplyMsg:{method:"post",url:"/deleteArticleReplyMsg",route:async(t,e)=>{const{articleId:a,messageId:r,userId:s,repeatId:i}=t.request.body;try{var{headers:{authorization:d}}=t,{_id:o}=parseToken(d);if(!(await User.findById(o)).admin&&s!==o)throw"无权限删除";var c=(await Article.findById(a,{message:1}))._doc.message||[];for await(const l of c)if(l._id==r){l.repeat=l.repeat.filter(e=>e._id!=i);break}await Article.updateOne({_id:a},{$set:{message:[...c]}}),t.body={success:!0}}catch(e){t.body={success:!1,errorMsg:e}}}},discussArticle:{method:"post",url:"/discussArticle",route:async a=>{const{msg:r,date:s=Date.now(),articleId:i,quickReply:d}=a.request.body;try{var{headers:{authorization:o}}=a;let e={};d||(e=parseToken(o));var c=escapeData(r),{_id:l}=e;if(!d&&!e._id)throw"登录过期，请重新登陆";var n=await Article.findById(i,{message:1,title:1});if(!n)throw"文章已不存在";const{message:m}=n,p=getClientIP(a);let t={ip:p};if(d){console.log("message",m);var u=m.find(e=>e.ip===p);if(u){const{ip:A,date:s}=u;if(A===p)if(Date.now()-new Date(Number(s)).getTime()<=864e5)throw"未登录一天只能回复一条，建议先登陆"}t={...t,name:"陌生人",avatar:"/upload/user_avatar/default_avatar.jpg"}}l&&(t.userId=l),await Article.updateOne({_id:i},{$set:{message:[...m,{msg:c,date:s,quickReply:d,...t}]}});const g=await Article.findById(i,{message:1});g.message=await setAllAvatar(g.message.reverse());var y=await User.findById(l,{name:1,email:1})||{};sendEmail(`hi，Ada，文章《${n.title}》评论中有了新的评论～\n
          ${y.name||"陌生人"}（${y.eamil||"email"}） 说 ：\n
          “${c}” \n
          详情(pc)：https://adaxh.site/article-detail?id=${i}&version=old
        `,"18668465750@163.com","文章新评论通知"),a.body={success:!0,data:g}}catch(e){console.log("error",e),a.body={success:!1,errorMsg:e}}}},replyArticleMsg:{method:"post",url:"/replyArticleMsg",route:async t=>{var{msg:e,date:a=Date.now(),toRepeatUserId:r,articleId:s,messageId:i}=t.request.body;try{var{headers:{authorization:d}}=t,{_id:o}=parseToken(d),c=await Article.findById(s,{message:1,title:1});if(!c)throw"文章已不存在";var{message:l}=c,n=escapeData(e);for await(const A of l){var{_id:u,repeat:y}=A;if(u==i){A.repeat=[...y,{msg:n,date:a,toRepeatUserId:r,userId:o}],await Article.updateOne({_id:s},{$set:{message:[...l]}});break}}const g=await Article.findById(s,{message:1}).sort({_id:-1});g.message=await setAllAvatar(g.message.reverse());var m=await User.findById(r),p=await User.findById(o);m&&m.email&&sendEmail(`hi，${m.name}，你在https://adaxh.site 的文章《${c.title}》评论中有了新的回复～\n
          ${p.name} 说 ：\n
          “${n}” \n
          详情(pc)：https://adaxh.site/article-detail?id=${s}&version=old

        `,m.email,"文章评论回复通知"),t.body={success:!0,data:g}}catch(e){console.log("error",e),t.body={success:!1,errorMsg:e}}}}};module.exports=routerExports;