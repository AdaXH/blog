const Message=require("../dbmodel/Message"),Article=require("../dbmodel/Article"),Dynamic=require("../dbmodel/Dynamic"),Customer=require("../dbmodel/Customer"),fs=require("fs"),Mood=require("../dbmodel/Mood"),{setAllAvatar}=require("../common/apiPrefix"),routerExports={};function callGetCustomer(){return new Promise((r,t)=>{Customer.findOne({}).then(e=>{e?r(e):t("网络出错")}).catch(e=>t(e instanceof Object?JSON.stringify(e):e.toString()))})}function moodArr(e){return new Promise((t,a)=>{console.log("native: "+e),Mood.find({},(e,r)=>{e?a([]):t(r)})})}function articleArr(){return new Promise((t,a)=>{Article.find({},(e,r)=>{r=r.sort((e,r)=>new Date(r.year+"-"+r.date).getTime()-new Date(e.year+"-"+e.date).getTime()).map(e=>(delete e._doc.summary,e));e?a([]):t(r)})})}function dynamicArr(){return new Promise((t,a)=>{Dynamic.find({},(e,r)=>{e?a([]):t(r.reverse())})})}function messageArr(){return new Promise((t,a)=>{Message.find({},(e,r)=>{e?a([]):t(r)})})}routerExports.getCustomer={method:"get",url:"/get-customer",route:async r=>{try{var e=await callGetCustomer();r.body={success:!0,data:e}}catch(e){r.body={success:!0,errorMsg:e,data:{}}}}},routerExports.addCustomer={method:"post",url:"/add-customer",route:async(e,r)=>{e.body=!0}},routerExports.getArticles={method:"get",url:"/getArticles",route:async(r,e)=>{try{const a=await Article.find({},{summary:0});var t=a.reverse().map(e=>{var{year:r,date:t,time:a="0:0:0"}=e;return/-/.test(t)&&(e.date=new Date(`${r}-${t}/${a}`)),e});r.body={success:!0,data:t}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports.getAllMessages={method:"get",url:"/getAllMessages",route:async r=>{try{r.body={success:!0};var e=await Message.find({}).sort({_id:-1}),t=await setAllAvatar(e);r.body={success:!0,data:t}}catch(e){r.body={success:!1,errorMsg:e}}}},routerExports["atom.xml"]={method:"get",url:"/atom.xml",route:async e=>{await fs.readFileSync("./public/feed.xml");e.response.header["Content-Type"]="application/xml",console.log("ctx.response",e.response)}},routerExports.feed={method:"get",url:"/feed",route:async e=>{var r=await fs.readFileSync("./public/feed.xml");e.response.header["Content-type"]="application/xml",e.body=r}},routerExports.routerIndex={method:"get",url:"/*",route:async(r,e)=>{var t=/Mobile+|iPhone+|Android/.test(r.request.header["user-agent"])?"Mobile":"pc",{request:{url:a}}=r;const o=new Date;var s=`${a||""} : ${o.getFullYear()}年${o.getMonth()+1}月${o.getDate()}号 : ${o.getHours()}点${o.getMinutes()}分${o.getSeconds()}秒`;if(/search/.test(a))await r.render("search");else if("Mobile"==t)await r.render(/old/.test(a)?"mobile":"new-mobile");else if(/twui/.test(a))console.log("twui: ",s),await r.render("twui");else if(/native/.test(a)){if("pc"==t)try{var i=await moodArr(s),n=await articleArr();const d=await messageArr(),u=await dynamicArr();var c=u.map(e=>{let r={};return r=e._doc?{...e._doc,img:e._doc.img?e._doc.img.replace(/jpeg/g,"jpg"):""}:{...e,img:e.img?e.img.replace(/jpeg/g,"jpg"):""},r});await r.render("native",{title:"Ada - 个人主页",mood:i,article:n,message:d.reverse(),dynamic:c})}catch(e){await r.render("native",{title:"Ada - 个人主页",mood:[],article:[],message:[],dynamic:[]})}}else await r.render("pc")}},module.exports=routerExports;